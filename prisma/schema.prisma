// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider  = "postgresql"
}

model User {
  id                String    @id @default(cuid())
  name              String?
  email             String?   @unique
  phoneNumber       String?   @unique
  password          String?
  provider          String    @default("credentials") // credentials, google, phone
  profileImage      String?
  
  // Cultural Identity Fields
  userType          UserType  @default(INDIGENE)
  village           String?   // For indigenes: their home village
  kindred           String?   // For indigenes: their umunna/clan
  hostVillage       String?   // For Ndi Ogo: village they associate with
  birthDate         DateTime?
  birthYear         Int?      // For accurate age grade calculation
  ageGrade          String?   // Authentic Alor age grade name
  generationalRole  String?   // "The Elders" or "The Workforce"
  
  onboardingCompleted Boolean @default(false)
  onboardingStep    Int       @default(1)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  profile           Profile?
  posts             Post[]
  comments          Comment[]
  discussions       Discussion[]
  replies           DiscussionReply[]
  familyNodes       FamilyNode[]
  ownedFamilyNodes  FamilyNode[] @relation("UserOwnedNodes")
  invitations       Invitation[]
  conversations     Conversation[] @relation("ConversationParticipants")
  sentMessages      Message[] @relation("SentMessages")
  notifications     Notification[]
}

model Profile {
  id      String  @id @default(cuid())
  bio     String?
  avatar  String?
  userId  String  @unique
  user    User    @relation(fields: [userId], references: [id])
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  type      String   // ARTICLE, BIOGRAPHY
  imageUrl  String?
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  comments  Comment[]
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  post      Post     @relation(fields: [postId], references: [id])
  postId    String
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  createdAt DateTime @default(now())
}

model Discussion {
  id        String            @id @default(cuid())
  title     String
  content   String
  village   String
  author    User              @relation(fields: [authorId], references: [id])
  authorId  String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  replies   DiscussionReply[]
}

model DiscussionReply {
  id           String     @id @default(cuid())
  content      String
  discussion   Discussion @relation(fields: [discussionId], references: [id])
  discussionId String
  author       User       @relation(fields: [authorId], references: [id])
  authorId     String
  createdAt    DateTime   @default(now())
}

model FamilyNode {
  id          String         @id @default(cuid())
  name        String
  birthDate   DateTime?
  deathDate   DateTime?
  gender      String?
  userId      String?        @unique
  user        User?          @relation(fields: [userId], references: [id])
  ownerId     String
  owner       User?          @relation("UserOwnedNodes", fields: [ownerId], references: [id], map: "FamilyNode_owner_fkey")
  relationshipsFrom Relationship[] @relation("RelationshipFrom")
  relationshipsTo   Relationship[] @relation("RelationshipTo")
}

model Relationship {
  id        String     @id @default(cuid())
  fromId    String
  toId      String
  type      String     // PARENT_CHILD, SPOUSE, SIBLING, GRANDPARENT_GRANDCHILD, AUNT_UNCLE_NIECE_NEPHEW, COUSIN
  isFlagged Boolean    @default(false)
  from      FamilyNode @relation("RelationshipFrom", fields: [fromId], references: [id])
  to        FamilyNode @relation("RelationshipTo", fields: [toId], references: [id])
}

model Invitation {
  id               String   @id @default(cuid())
  email            String
  senderId         String
  sender           User     @relation(fields: [senderId], references: [id])
  relationshipType String
  status           String   @default("PENDING") // PENDING, ACCEPTED
  createdAt        DateTime @default(now())
}

model Conversation {
  id            String    @id @default(cuid())
  participantIds String[]
  participants  User[]    @relation("ConversationParticipants")
  messages      Message[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([participantIds])
}

model Message {
  id             String       @id @default(cuid())
  content        String       @db.Text
  senderId       String
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())
  
  @@index([conversationId])
  @@index([senderId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // MESSAGE, REPLY, COMMENT, TREE_DISPUTE, etc.
  title     String
  message   String
  link      String?  // URL to navigate to when clicked
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([read])
}

enum UserType {
  INDIGENE  // Ndi Alor - full members with village and kindred
  NDI_OGO   // Inlaws - married into Alor families
  FRIEND    // Friends of Alor - associates and supporters
}
